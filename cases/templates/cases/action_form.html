{% extends "base.html" %}
{% load crispy_forms_tags crispy_forms_gds static %}

{% block content %}

<div>
    <a href="{% url "case-view" case.id %}" class="nw-back-link">Cancel, back to case</a>
</div>

{% include "cases/_case_tags.html" with case=case %}
<h1 style="margin-top: 0">{{form_title}}</h1>

{% error_summary form %}
{% crispy form %}

<script>
(function() {
    const pond = FilePond.create(document.querySelector('input[type="file"]'));
    const remainingStorageBytes = {{ remaining_file_storage_bytes }};
    const submitButton = document.querySelector('input[type="submit"]');
    const filesTooBigPrompt = document.querySelector('div[name="files-too-big-prompt"]');

    pond.setOptions({
        {% if not can_upload_files %}
            disabled: true,
        {% endif %}
        storeAsFile: true,  // Store as hidden elements posted along with form.
    });
    document.addEventListener('FilePond:updatefiles', function() {
        let totalSize = 0;
        for (const file of pond.getFiles()) {
            totalSize += file.fileSize;
        }
        if (submitButton) {
            submitButton.disabled = totalSize > remainingStorageBytes;
        }
        if (filesTooBigPrompt) {
            filesTooBigPrompt.hidden = totalSize <= remainingStorageBytes;
        }
    });

    let typeRadioButtons = document.querySelectorAll('input[type="radio"][name="type"]');
    let closePrompt = document.querySelector('div[name="close-prompt"]');
    if (!closePrompt || typeRadioButtons.length === 0) {
        return;
    }
    typeRadioButtons.forEach(function(rb) {
        rb.addEventListener('change', function(_) {
            let closeChecked = rb.checked && rb.value == {{ close_type_id }};
            closePrompt.hidden = !closeChecked;
        });
    });
})();
</script>

{% endblock %}
